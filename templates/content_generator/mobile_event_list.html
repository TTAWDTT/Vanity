{% extends "mobile_base.html" %}

{% block title %}æ—¥è®° - Vanity{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="mobile-stats-grid">
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-primary);">{{ total_events }}</div>
        <div class="mobile-stat-label">æ€»è®°å½•</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-success);">{{ this_month_events }}</div>
        <div class="mobile-stat-label">æœ¬æœˆ</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-warning);">{{ this_week_events }}</div>
        <div class="mobile-stat-label">æœ¬å‘¨</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-danger);">{{ today_events }}</div>
        <div class="mobile-stat-label">ä»Šæ—¥</div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ -->
<div class="mobile-quick-actions">
    <a href="{% url 'content_generator:add_event' %}" class="mobile-quick-btn primary">
        <span>â•</span>
        <span>å†™æ—¥è®°</span>
    </a>
    <button class="mobile-quick-btn" onclick="filterByMood('all')">å…¨éƒ¨</button>
    <div style="display: flex; gap: 0.25rem;">
        <button class="mobile-quick-btn" onclick="filterByMood('ğŸ˜„')" title="å¼€å¿ƒ">ğŸ˜„</button>
        <button class="mobile-quick-btn" onclick="filterByMood('ğŸ˜¢')" title="æ‚²ä¼¤">ğŸ˜¢</button>
        <button class="mobile-quick-btn" onclick="filterByMood('ğŸ˜ ')" title="æ„¤æ€’">ğŸ˜ </button>
        <button class="mobile-quick-btn" onclick="filterByMood('ğŸ˜²')" title="æƒŠè®¶">ğŸ˜²</button>
    </div>
</div>

<!-- æ—¥è®°åˆ—è¡¨ -->
<div class="mobile-task-list" id="eventList">
    {% for event in events %}
    <div class="mobile-task-card slide-up" data-mood="{{ event.mood }}">
        <div class="mobile-task-header">
            <h3 class="mobile-task-title">{{ event.title }}</h3>
            <div class="mobile-task-priority" title="å¿ƒæƒ…">{{ event.mood }}</div>
        </div>
        
        <div class="mobile-task-meta">
            <div title="åˆ›å»ºæ—¶é—´">ğŸ“… {{ event.created_at|date:"mæœˆdæ—¥ H:i" }}</div>
        </div>
        
        <div class="mobile-task-description">
            {{ event.content|truncatechars:100 }}
        </div>
        
        {% if event.image %}
        <div style="margin: 1rem 0;">
            <img src="{{ event.image.url }}" alt="æ—¥è®°å›¾ç‰‡" 
                 style="max-width: 100%; border-radius: 8px; box-shadow: 0 4px 8px var(--mobile-shadow);">
        </div>
        {% endif %}
        
        <div class="mobile-task-actions">
            <button class="mobile-action-btn" data-action="generate" data-event-id="{{ event.id }}" title="ç”Ÿæˆå†…å®¹">
                <i class="fas fa-magic"></i> ç”Ÿæˆ
            </button>
        </div>
    </div>
    {% empty %}
    <!-- ç©ºçŠ¶æ€ -->
    <div class="mobile-empty-state">
        <div class="mobile-empty-icon">ğŸ“–</div>
        <div class="mobile-empty-title">è¿˜æ²¡æœ‰æ—¥è®°è®°å½•</div>
        <div class="mobile-empty-description">ç‚¹å‡»"å†™æ—¥è®°"å¼€å§‹è®°å½•ç”Ÿæ´»ç‚¹æ»´å§ï¼</div>
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block extra_js %}
<script>
// å¿ƒæƒ…ç­›é€‰åŠŸèƒ½
function filterByMood(mood) {
    const events = document.querySelectorAll('.mobile-task-card[data-mood]');
    const buttons = document.querySelectorAll('.mobile-quick-btn');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // ç­›é€‰æ—¥è®°
    events.forEach(event => {
        if (mood === 'all' || event.getAttribute('data-mood') === mood) {
            event.style.display = 'block';
            event.classList.add('slide-up');
        } else {
            event.style.display = 'none';
        }
    });
}

// ç”Ÿæˆå†…å®¹
function generateContent(eventId, button) {
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
    button.disabled = true;
    
    fetch(`/content/generate-content/${eventId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.content) {
            alert(data.content);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        button.innerHTML = originalText;
        button.disabled = false;
        alert('ç”Ÿæˆå†…å®¹æ—¶å‡ºé”™ï¼Œè¯·é‡è¯•');
    });
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// äº‹ä»¶å§”æ‰˜å¤„ç†æŒ‰é’®ç‚¹å‡»
document.addEventListener('DOMContentLoaded', function() {
    document.addEventListener('click', function(e) {
        const action = e.target.closest('button')?.getAttribute('data-action');
        const eventId = e.target.closest('button')?.getAttribute('data-event-id');
        
        if (action && eventId) {
            switch(action) {
                case 'generate':
                    generateContent(eventId, e.target.closest('button'));
                    break;
            }
        }
    });
});
</script>
{% endblock %}