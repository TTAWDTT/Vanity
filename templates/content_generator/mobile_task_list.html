{% extends "mobile_base.html" %}

{% block title %}任务管理 - Vanity{% endblock %}

{% block content %}
<!-- 统计卡片 -->
<div class="mobile-stats-grid">
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-primary);">{{ total_tasks }}</div>
        <div class="mobile-stat-label">总任务</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-success);">{{ completed_tasks }}</div>
        <div class="mobile-stat-label">已完成</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-warning);">{{ pending_tasks }}</div>
        <div class="mobile-stat-label">待完成</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-danger);">{{ overdue_tasks }}</div>
        <div class="mobile-stat-label">已逾期</div>
    </div>
</div>

<!-- 快速操作 -->
<div class="mobile-quick-actions">
    <a href="{% url 'add_task' %}" class="mobile-quick-btn primary">
        <span>➕</span>
        <span>添加任务</span>
    </a>
    <button class="mobile-quick-btn" onclick="filterTasks('all')">
        <span>📋</span>
        <span>全部</span>
    </button>
    <button class="mobile-quick-btn" onclick="filterTasks('pending')">
        <span>⏳</span>
        <span>待完成</span>
    </button>
    <button class="mobile-quick-btn" onclick="filterTasks('completed')">
        <span>✅</span>
        <span>已完成</span>
    </button>
</div>

<!-- 任务列表 -->
<div class="mobile-task-list" id="taskList">
    {% for task in tasks %}
    <div class="mobile-task-card {% if task.completed %}completed{% endif %} fade-in" data-task-id="{{ task.id }}" data-filter="{% if task.completed %}completed{% else %}pending{% endif %}">
        <div class="mobile-task-header">
            <h3 class="mobile-task-title">
                {% if task.completed %}✅ {% endif %}{{ task.title }}
            </h3>
            <div class="mobile-task-priority" title="优先级">
                {% if task.priority == 'high' %}♛♛♛
                {% elif task.priority == 'medium' %}♛♛
                {% else %}♛{% endif %}
            </div>
        </div>
        
        <div class="mobile-task-meta">
            <div class="mobile-task-willingness" title="意愿度">{{ task.willingness }}</div>
            {% if task.due_date %}
            <div title="截止时间">📅 {{ task.due_date|date:"m月d日 H:i" }}</div>
            {% endif %}
            <div title="创建时间">⏰ {{ task.created_at|date:"m月d日" }}</div>
        </div>
        
        {% if task.description %}
        <div class="mobile-task-description">
            {{ task.description|truncatechars:80 }}
        </div>
        {% endif %}
        
        <div class="mobile-task-actions">
            <button class="mobile-action-btn {% if task.completed %}danger{% else %}success{% endif %}" 
                    data-action="toggle" data-task-id="{{ task.id }}"
                    title="{% if task.completed %}取消完成{% else %}标记完成{% endif %}">
                {% if task.completed %}❌{% else %}✅{% endif %}
            </button>
            <button class="mobile-action-btn" data-action="edit" data-task-id="{{ task.id }}" title="编辑">✏️</button>
            <button class="mobile-action-btn" data-action="advice" data-task-id="{{ task.id }}" title="建议">💡</button>
            <button class="mobile-action-btn danger" data-action="delete" data-task-id="{{ task.id }}" title="删除">🗑️</button>
        </div>
        
        <!-- 滑动删除操作 -->
        <div class="mobile-swipe-actions">
            <button data-action="delete" data-task-id="{{ task.id }}" style="background: none; border: none; color: white; font-size: 1.5rem;">🗑️</button>
        </div>
    </div>
    {% empty %}
    <!-- 空状态 -->
    <div class="mobile-empty-state">
        <div class="mobile-empty-icon">📋</div>
        <div class="mobile-empty-title">还没有任务</div>
        <div class="mobile-empty-description">点击下方的"添加"按钮创建你的第一个任务吧！</div>
    </div>
    {% endfor %}
</div>

<!-- 浮动添加按钮（仅在列表有内容时显示） -->
{% if tasks %}
<button class="mobile-fab" data-action="add-task" style="
    position: fixed;
    bottom: 100px;
    right: 1rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: var(--mobile-shadow);
    z-index: 100;
    transition: all 0.3s ease;
">
    ➕
</button>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// 事件委托处理所有按钮点击
document.addEventListener('DOMContentLoaded', function() {
    // 为所有按钮添加事件监听器
    document.addEventListener('click', function(e) {
        const action = e.target.getAttribute('data-action');
        const taskId = e.target.getAttribute('data-task-id');
        
        if (action && taskId) {
            switch(action) {
                case 'toggle':
                    toggleTask(taskId);
                    break;
                case 'edit':
                    editTask(taskId);
                    break;
                case 'advice':
                    getTaskAdvice(taskId);
                    break;
                case 'delete':
                    deleteTask(taskId);
                    break;
            }
        } else if (action === 'add-task') {
            window.location.href = "{% url 'add_task' %}";
        }
    });
});

// 任务筛选功能
function filterTasks(filter) {
    const tasks = document.querySelectorAll('.mobile-task-card');
    const buttons = document.querySelectorAll('.mobile-quick-btn');
    
    // 更新按钮状态
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // 筛选任务
    tasks.forEach(task => {
        const taskFilter = task.getAttribute('data-filter');
        if (filter === 'all' || taskFilter === filter) {
            task.style.display = 'block';
            task.classList.add('slide-up');
        } else {
            task.style.display = 'none';
        }
    });
}

// 切换任务完成状态
function toggleTask(taskId) {
    fetch(`/content/tasks/${taskId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // 添加成功反馈
            showToast(data.completed ? '✅ 任务已完成' : '↩️ 已取消完成');
            // 延迟刷新页面以显示动画
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('❌ 操作失败，请重试');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('❌ 网络错误，请重试');
    });
}

// 删除任务
function deleteTask(taskId) {
    if (confirm('确定要删除这个任务吗？此操作不可撤销。')) {
        fetch(`/content/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('🗑️ 任务已删除');
                // 添加删除动画
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.style.transform = 'translateX(100%)';
                    taskCard.style.opacity = '0';
                    setTimeout(() => {
                        taskCard.remove();
                    }, 300);
                }
            } else {
                showToast('❌ 删除失败，请重试');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('❌ 网络错误，请重试');
        });
    }
}

// 编辑任务
function editTask(taskId) {
    window.location.href = `/content/tasks/${taskId}/edit/`;
}

// 获取任务建议
function getTaskAdvice(taskId) {
    showToast('💡 AI建议功能开发中...');
}

// 显示Toast消息
function showToast(message) {
    // 移除现有的toast
    const existingToast = document.getElementById('mobileToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // 创建新的toast
    const toast = document.createElement('div');
    toast.id = 'mobileToast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: calc(env(safe-area-inset-top, 20px) + 80px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--mobile-text);
        color: var(--mobile-card);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 10000;
        box-shadow: var(--mobile-shadow);
        animation: slideUp 0.3s ease-out;
        max-width: calc(100vw - 2rem);
        text-align: center;
    `;
    
    document.body.appendChild(toast);
    
    // 3秒后自动消失
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// 获取CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// 滑动删除功能
let startX = 0;
let currentX = 0;
let isDragging = false;
let draggedCard = null;

document.addEventListener('touchstart', function(e) {
    if (e.target.closest('.mobile-task-card')) {
        startX = e.touches[0].clientX;
        draggedCard = e.target.closest('.mobile-task-card');
        isDragging = true;
    }
}, {passive: true});

document.addEventListener('touchmove', function(e) {
    if (!isDragging || !draggedCard) return;
    
    currentX = e.touches[0].clientX;
    const diffX = startX - currentX;
    
    if (diffX > 0 && diffX < 100) {
        draggedCard.style.transform = `translateX(-${diffX}px)`;
    }
}, {passive: true});

document.addEventListener('touchend', function(e) {
    if (!isDragging || !draggedCard) return;
    
    const diffX = startX - currentX;
    
    if (diffX > 50) {
        // 显示删除按钮
        draggedCard.classList.add('swipe-open');
        draggedCard.style.transform = 'translateX(-100px)';
    } else {
        // 恢复原位
        draggedCard.classList.remove('swipe-open');
        draggedCard.style.transform = '';
    }
    
    isDragging = false;
    draggedCard = null;
    startX = 0;
    currentX = 0;
}, {passive: true});

// 点击其他地方关闭滑动操作
document.addEventListener('click', function(e) {
    if (!e.target.closest('.mobile-task-card.swipe-open') && 
        !e.target.closest('.mobile-swipe-actions')) {
        const openCards = document.querySelectorAll('.mobile-task-card.swipe-open');
        openCards.forEach(card => {
            card.classList.remove('swipe-open');
            card.style.transform = '';
        });
    }
});

// 下拉刷新
let startY = 0;
let pullDistance = 0;
let isRefreshing = false;

document.addEventListener('touchstart', function(e) {
    if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
    }
}, {passive: true});

document.addEventListener('touchmove', function(e) {
    if (window.scrollY === 0 && !isRefreshing) {
        const currentY = e.touches[0].clientY;
        pullDistance = currentY - startY;
        
        if (pullDistance > 0 && pullDistance < 100) {
            const header = document.querySelector('.mobile-header');
            header.style.transform = `translateY(${pullDistance * 0.5}px)`;
            header.style.opacity = 1 - (pullDistance * 0.01);
        }
    }
}, {passive: true});

document.addEventListener('touchend', function(e) {
    if (pullDistance > 60 && !isRefreshing) {
        isRefreshing = true;
        showToast('🔄 正在刷新...');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } else {
        const header = document.querySelector('.mobile-header');
        header.style.transform = '';
        header.style.opacity = '';
    }
    pullDistance = 0;
    startY = 0;
}, {passive: true});
</script>
{% endblock %}