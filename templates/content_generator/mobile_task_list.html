{% extends "mobile_base.html" %}

{% block title %}ä»»åŠ¡ç®¡ç† - Vanity{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="mobile-stats-grid">
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-primary);">{{ total_tasks }}</div>
        <div class="mobile-stat-label">æ€»ä»»åŠ¡</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-success);">{{ completed_tasks }}</div>
        <div class="mobile-stat-label">å·²å®Œæˆ</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-warning);">{{ pending_tasks }}</div>
        <div class="mobile-stat-label">å¾…å®Œæˆ</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-danger);">{{ overdue_tasks }}</div>
        <div class="mobile-stat-label">å·²é€¾æœŸ</div>
    </div>
</div>

<!-- å¿«é€Ÿæ“ä½œ -->
<div class="mobile-quick-actions">
    <a href="{% url 'add_task' %}" class="mobile-quick-btn primary">
        <span>â•</span>
        <span>æ·»åŠ ä»»åŠ¡</span>
    </a>
    <button class="mobile-quick-btn" onclick="filterTasks('all')">
        <span>ğŸ“‹</span>
        <span>å…¨éƒ¨</span>
    </button>
    <button class="mobile-quick-btn" onclick="filterTasks('pending')">
        <span>â³</span>
        <span>å¾…å®Œæˆ</span>
    </button>
    <button class="mobile-quick-btn" onclick="filterTasks('completed')">
        <span>âœ…</span>
        <span>å·²å®Œæˆ</span>
    </button>
</div>

<!-- ä»»åŠ¡åˆ—è¡¨ -->
<div class="mobile-task-list" id="taskList">
    {% for task in tasks %}
    <div class="mobile-task-card {% if task.completed %}completed{% endif %} fade-in" data-task-id="{{ task.id }}" data-filter="{% if task.completed %}completed{% else %}pending{% endif %}">
        <div class="mobile-task-header">
            <h3 class="mobile-task-title">
                {% if task.completed %}âœ… {% endif %}{{ task.title }}
            </h3>
            <div class="mobile-task-priority" title="ä¼˜å…ˆçº§">
                {% if task.priority == 'high' %}â™›â™›â™›
                {% elif task.priority == 'medium' %}â™›â™›
                {% else %}â™›{% endif %}
            </div>
        </div>
        
        <div class="mobile-task-meta">
            <div class="mobile-task-willingness" title="æ„æ„¿åº¦">{{ task.willingness }}</div>
            {% if task.due_date %}
            <div title="æˆªæ­¢æ—¶é—´">ğŸ“… {{ task.due_date|date:"mæœˆdæ—¥ H:i" }}</div>
            {% endif %}
            <div title="åˆ›å»ºæ—¶é—´">â° {{ task.created_at|date:"mæœˆdæ—¥" }}</div>
        </div>
        
        {% if task.description %}
        <div class="mobile-task-description">
            {{ task.description|truncatechars:80 }}
        </div>
        {% endif %}
        
        <div class="mobile-task-actions">
            <button class="mobile-action-btn {% if task.completed %}danger{% else %}success{% endif %}" 
                    data-action="toggle" data-task-id="{{ task.id }}"
                    title="{% if task.completed %}å–æ¶ˆå®Œæˆ{% else %}æ ‡è®°å®Œæˆ{% endif %}">
                {% if task.completed %}âŒ{% else %}âœ…{% endif %}
            </button>
            <button class="mobile-action-btn" data-action="edit" data-task-id="{{ task.id }}" title="ç¼–è¾‘">âœï¸</button>
            <button class="mobile-action-btn" data-action="advice" data-task-id="{{ task.id }}" title="å»ºè®®">ğŸ’¡</button>
            <button class="mobile-action-btn danger" data-action="delete" data-task-id="{{ task.id }}" title="åˆ é™¤">ğŸ—‘ï¸</button>
        </div>
        
        <!-- æ»‘åŠ¨åˆ é™¤æ“ä½œ -->
        <div class="mobile-swipe-actions">
            <button data-action="delete" data-task-id="{{ task.id }}" style="background: none; border: none; color: white; font-size: 1.5rem;">ğŸ—‘ï¸</button>
        </div>
    </div>
    {% empty %}
    <!-- ç©ºçŠ¶æ€ -->
    <div class="mobile-empty-state">
        <div class="mobile-empty-icon">ğŸ“‹</div>
        <div class="mobile-empty-title">è¿˜æ²¡æœ‰ä»»åŠ¡</div>
        <div class="mobile-empty-description">ç‚¹å‡»ä¸‹æ–¹çš„"æ·»åŠ "æŒ‰é’®åˆ›å»ºä½ çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å§ï¼</div>
    </div>
    {% endfor %}
</div>

<!-- æµ®åŠ¨æ·»åŠ æŒ‰é’®ï¼ˆä»…åœ¨åˆ—è¡¨æœ‰å†…å®¹æ—¶æ˜¾ç¤ºï¼‰ -->
{% if tasks %}
<button class="mobile-fab" data-action="add-task" style="
    position: fixed;
    bottom: 100px;
    right: 1rem;
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
    border: none;
    color: white;
    font-size: 1.5rem;
    box-shadow: var(--mobile-shadow);
    z-index: 100;
    transition: all 0.3s ease;
">
    â•
</button>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// äº‹ä»¶å§”æ‰˜å¤„ç†æ‰€æœ‰æŒ‰é’®ç‚¹å‡»
document.addEventListener('DOMContentLoaded', function() {
    // ä¸ºæ‰€æœ‰æŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬å™¨
    document.addEventListener('click', function(e) {
        const action = e.target.getAttribute('data-action');
        const taskId = e.target.getAttribute('data-task-id');
        
        if (action && taskId) {
            switch(action) {
                case 'toggle':
                    toggleTask(taskId);
                    break;
                case 'edit':
                    editTask(taskId);
                    break;
                case 'advice':
                    getTaskAdvice(taskId);
                    break;
                case 'delete':
                    deleteTask(taskId);
                    break;
            }
        } else if (action === 'add-task') {
            window.location.href = "{% url 'add_task' %}";
        }
    });
});

// ä»»åŠ¡ç­›é€‰åŠŸèƒ½
function filterTasks(filter) {
    const tasks = document.querySelectorAll('.mobile-task-card');
    const buttons = document.querySelectorAll('.mobile-quick-btn');
    
    // æ›´æ–°æŒ‰é’®çŠ¶æ€
    buttons.forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    // ç­›é€‰ä»»åŠ¡
    tasks.forEach(task => {
        const taskFilter = task.getAttribute('data-filter');
        if (filter === 'all' || taskFilter === filter) {
            task.style.display = 'block';
            task.classList.add('slide-up');
        } else {
            task.style.display = 'none';
        }
    });
}

// åˆ‡æ¢ä»»åŠ¡å®ŒæˆçŠ¶æ€
function toggleTask(taskId) {
    fetch(`/content/tasks/${taskId}/toggle/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // æ·»åŠ æˆåŠŸåé¦ˆ
            showToast(data.completed ? 'âœ… ä»»åŠ¡å·²å®Œæˆ' : 'â†©ï¸ å·²å–æ¶ˆå®Œæˆ');
            // å»¶è¿Ÿåˆ·æ–°é¡µé¢ä»¥æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            showToast('âŒ æ“ä½œå¤±è´¥ï¼Œè¯·é‡è¯•');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
    });
}

// åˆ é™¤ä»»åŠ¡
function deleteTask(taskId) {
    if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªä»»åŠ¡å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
        fetch(`/content/tasks/${taskId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showToast('ğŸ—‘ï¸ ä»»åŠ¡å·²åˆ é™¤');
                // æ·»åŠ åˆ é™¤åŠ¨ç”»
                const taskCard = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskCard) {
                    taskCard.style.transform = 'translateX(100%)';
                    taskCard.style.opacity = '0';
                    setTimeout(() => {
                        taskCard.remove();
                    }, 300);
                }
            } else {
                showToast('âŒ åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·é‡è¯•');
        });
    }
}

// ç¼–è¾‘ä»»åŠ¡
function editTask(taskId) {
    window.location.href = `/content/tasks/${taskId}/edit/`;
}

// è·å–ä»»åŠ¡å»ºè®®
function getTaskAdvice(taskId) {
    showToast('ğŸ’¡ AIå»ºè®®åŠŸèƒ½å¼€å‘ä¸­...');
}

// æ˜¾ç¤ºToastæ¶ˆæ¯
function showToast(message) {
    // ç§»é™¤ç°æœ‰çš„toast
    const existingToast = document.getElementById('mobileToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    // åˆ›å»ºæ–°çš„toast
    const toast = document.createElement('div');
    toast.id = 'mobileToast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: calc(env(safe-area-inset-top, 20px) + 80px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--mobile-text);
        color: var(--mobile-card);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 10000;
        box-shadow: var(--mobile-shadow);
        animation: slideUp 0.3s ease-out;
        max-width: calc(100vw - 2rem);
        text-align: center;
    `;
    
    document.body.appendChild(toast);
    
    // 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}

// è·å–CSRF Token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// æ»‘åŠ¨åˆ é™¤åŠŸèƒ½
let startX = 0;
let currentX = 0;
let isDragging = false;
let draggedCard = null;

document.addEventListener('touchstart', function(e) {
    if (e.target.closest('.mobile-task-card')) {
        startX = e.touches[0].clientX;
        draggedCard = e.target.closest('.mobile-task-card');
        isDragging = true;
    }
}, {passive: true});

document.addEventListener('touchmove', function(e) {
    if (!isDragging || !draggedCard) return;
    
    currentX = e.touches[0].clientX;
    const diffX = startX - currentX;
    
    if (diffX > 0 && diffX < 100) {
        draggedCard.style.transform = `translateX(-${diffX}px)`;
    }
}, {passive: true});

document.addEventListener('touchend', function(e) {
    if (!isDragging || !draggedCard) return;
    
    const diffX = startX - currentX;
    
    if (diffX > 50) {
        // æ˜¾ç¤ºåˆ é™¤æŒ‰é’®
        draggedCard.classList.add('swipe-open');
        draggedCard.style.transform = 'translateX(-100px)';
    } else {
        // æ¢å¤åŸä½
        draggedCard.classList.remove('swipe-open');
        draggedCard.style.transform = '';
    }
    
    isDragging = false;
    draggedCard = null;
    startX = 0;
    currentX = 0;
}, {passive: true});

// ç‚¹å‡»å…¶ä»–åœ°æ–¹å…³é—­æ»‘åŠ¨æ“ä½œ
document.addEventListener('click', function(e) {
    if (!e.target.closest('.mobile-task-card.swipe-open') && 
        !e.target.closest('.mobile-swipe-actions')) {
        const openCards = document.querySelectorAll('.mobile-task-card.swipe-open');
        openCards.forEach(card => {
            card.classList.remove('swipe-open');
            card.style.transform = '';
        });
    }
});

// ä¸‹æ‹‰åˆ·æ–°
let startY = 0;
let pullDistance = 0;
let isRefreshing = false;

document.addEventListener('touchstart', function(e) {
    if (window.scrollY === 0) {
        startY = e.touches[0].clientY;
    }
}, {passive: true});

document.addEventListener('touchmove', function(e) {
    if (window.scrollY === 0 && !isRefreshing) {
        const currentY = e.touches[0].clientY;
        pullDistance = currentY - startY;
        
        if (pullDistance > 0 && pullDistance < 100) {
            const header = document.querySelector('.mobile-header');
            header.style.transform = `translateY(${pullDistance * 0.5}px)`;
            header.style.opacity = 1 - (pullDistance * 0.01);
        }
    }
}, {passive: true});

document.addEventListener('touchend', function(e) {
    if (pullDistance > 60 && !isRefreshing) {
        isRefreshing = true;
        showToast('ğŸ”„ æ­£åœ¨åˆ·æ–°...');
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    } else {
        const header = document.querySelector('.mobile-header');
        header.style.transform = '';
        header.style.opacity = '';
    }
    pullDistance = 0;
    startY = 0;
}, {passive: true});
</script>
{% endblock %}