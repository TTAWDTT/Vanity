{% extends "mobile_base.html" %}

{% block title %}æ—¥æ€»ç»“ - Vanity{% endblock %}

{% block content %}
<!-- ç»Ÿè®¡å¡ç‰‡ -->
<div class="mobile-stats-grid">
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-primary);">{{ total_summaries }}</div>
        <div class="mobile-stat-label">æ€»ç»“æ•°</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-success);">{{ this_month_summaries }}</div>
        <div class="mobile-stat-label">æœ¬æœˆ</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-warning);">{{ this_week_summaries }}</div>
        <div class="mobile-stat-label">æœ¬å‘¨</div>
    </div>
    <div class="mobile-stat-card">
        <div class="mobile-stat-number" style="color: var(--mobile-danger);">{{ streak_days }}</div>
        <div class="mobile-stat-label">è¿ç»­å¤©æ•°</div>
    </div>
</div>

<!-- è¿›åº¦æ¡ -->
<div class="mobile-task-card" style="margin-bottom: 1rem;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span style="font-size: 0.875rem; color: var(--mobile-text-light);">æœ¬æœˆå®Œæˆåº¦</span>
        <span style="font-size: 0.875rem; font-weight: 600;">{{ month_progress }}%</span>
    </div>
    <div style="height: 8px; background: var(--mobile-border); border-radius: 4px; overflow: hidden;">
        <div style="height: 100%; background: var(--mobile-primary); border-radius: 4px; width: {{ month_progress }}%;"></div>
    </div>
</div>

<div class="mobile-task-card" style="margin-bottom: 1rem;">
    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
        <span style="font-size: 0.875rem; color: var(--mobile-text-light);">æœ¬å‘¨å®Œæˆåº¦</span>
        <span style="font-size: 0.875rem; font-weight: 600;">{{ week_progress }}%</span>
    </div>
    <div style="height: 8px; background: var(--mobile-border); border-radius: 4px; overflow: hidden;">
        <div style="height: 100%; background: var(--mobile-secondary); border-radius: 4px; width: {{ week_progress }}%;"></div>
    </div>
</div>

<!-- æ€»ç»“è¡¨å• -->
<div class="mobile-form">
    <h2 class="mobile-form-title">ğŸ“ åˆ›å»ºä»Šæ—¥æ€»ç»“</h2>
    
    <form method="post" id="summaryForm">
        {% csrf_token %}
        
        <div class="mobile-form-group">
            <label for="date" class="mobile-form-label">ğŸ“… æ—¥æœŸ</label>
            <input type="date" 
                   id="date" 
                   name="date" 
                   class="mobile-form-input" 
                   value="{{ today|date:'Y-m-d' }}"
                   required>
        </div>

        <div class="mobile-form-group">
            <label for="summary" class="mobile-form-label">âœï¸ ä»Šæ—¥æ€»ç»“</label>
            <textarea id="summary" 
                      name="summary" 
                      class="mobile-form-textarea" 
                      placeholder="ä»Šå¤©åšäº†ä»€ä¹ˆï¼Œæœ‰ä»€ä¹ˆæ”¶è·å’Œæ„Ÿæ‚Ÿ..."
                      required></textarea>
        </div>

        <div class="mobile-form-group">
            <label for="work_evaluation" class="mobile-form-label">â­ å·¥ä½œè¯„ä¼° (å¯é€‰)</label>
            <textarea id="work_evaluation" 
                      name="work_evaluation" 
                      class="mobile-form-textarea" 
                      placeholder="å¯¹ä»Šå¤©å·¥ä½œè¡¨ç°çš„è¯„ä¼°å’Œæ”¹è¿›å»ºè®®..."></textarea>
        </div>

        <button type="submit" class="mobile-submit-btn">
            <i class="fas fa-save"></i> ä¿å­˜æ€»ç»“
        </button>
    </form>
</div>

<!-- AIæ™ºèƒ½æ€»ç»“æŒ‰é’® -->
<div class="mobile-task-card" style="margin-top: 1rem; text-align: center;">
    <button class="mobile-submit-btn" onclick="generateAISummary()" style="background: linear-gradient(135deg, var(--mobile-accent), #f72585);">
        <i class="fas fa-robot"></i> AIæ™ºèƒ½æ€»ç»“
    </button>
</div>

<!-- æœ€è¿‘æ€»ç»“ -->
{% if summaries %}
<div style="margin-top: 2rem;">
    <h3 style="font-size: 1.25rem; font-weight: 600; margin-bottom: 1rem; color: var(--mobile-text);">ğŸ“š æœ€è¿‘æ€»ç»“</h3>
    
    {% for summary in summaries %}
    <div class="mobile-task-card" style="margin-bottom: 1rem;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
            <span style="font-weight: 600; color: var(--mobile-primary);">
                <i class="fas fa-calendar-day"></i> {{ summary.date|date:"Yå¹´mæœˆdæ—¥" }}
            </span>
        </div>
        <div style="color: var(--mobile-text-light); margin-bottom: 0.5rem; line-height: 1.5;">
            {{ summary.summary|truncatewords:30 }}
        </div>
        {% if summary.work_evaluation %}
        <div style="background: rgba(67, 97, 238, 0.1); border-left: 3px solid var(--mobile-primary); padding: 0.75rem; border-radius: 0 8px 8px 0; color: var(--mobile-text); font-size: 0.875rem;">
            <strong>å·¥ä½œè¯„ä¼°ï¼š</strong>{{ summary.work_evaluation|truncatewords:20 }}
        </div>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
// è‡ªåŠ¨ç”ŸæˆAIæ€»ç»“
function generateAISummary() {
    const button = event.target.closest('button');
    const originalText = button.innerHTML;
    button.innerHTML = '<span class="loading"></span> ç”Ÿæˆä¸­...';
    button.disabled = true;
    
    fetch('/content/summary/generate/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalText;
        button.disabled = false;
        
        if (data.summary) {
            document.getElementById('summary').value = data.summary;
            if (data.work_evaluation) {
                document.getElementById('work_evaluation').value = data.work_evaluation;
            }
            showToast('âœ… AIæ€»ç»“ç”ŸæˆæˆåŠŸ');
        }
    })
    .catch(error => {
        button.innerHTML = originalText;
        button.disabled = false;
        showToast('âŒ ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åå†è¯•');
    });
}

// è·å–CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// è¡¨å•éªŒè¯
document.getElementById('summaryForm').addEventListener('submit', function(e) {
    const summary = document.getElementById('summary').value.trim();
    
    if (summary.length < 10) {
        e.preventDefault();
        showToast('âŒ æ€»ç»“å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦ï¼');
        return;
    }
});

// è‡ªåŠ¨è°ƒæ•´æ–‡æœ¬åŸŸé«˜åº¦
document.querySelectorAll('.mobile-form-textarea').forEach(textarea => {
    textarea.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
    });
});

// Toastæ¶ˆæ¯æ˜¾ç¤º
function showToast(message) {
    const existingToast = document.getElementById('mobileToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.id = 'mobileToast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: calc(env(safe-area-inset-top, 20px) + 80px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--mobile-text);
        color: var(--mobile-card);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 10000;
        box-shadow: var(--mobile-shadow);
        animation: slideUp 0.3s ease-out;
        max-width: calc(100vw - 2rem);
        text-align: center;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            toast.remove();
        }, 3000);
    }, 3000);
}

// LoadingåŠ¨ç”»
const loading = document.createElement('style');
loading.textContent = `
    .loading {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid var(--mobile-border);
        border-radius: 50%;
        border-top-color: var(--mobile-primary);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
`;
document.head.appendChild(loading);
</script>
{% endblock %}