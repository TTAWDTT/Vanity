{% extends "mobile_base.html" %}

{% block title %}å†™æ—¥è®° - Vanity{% endblock %}

{% block content %}
<div class="mobile-form">
    <h2 class="mobile-form-title">ğŸ“– å†™æ—¥è®°</h2>
    
    <form method="post" enctype="multipart/form-data" id="diaryForm">
        {% csrf_token %}
        
        <div class="mobile-form-group">
            <label for="title" class="mobile-form-label">ğŸ“ æ—¥è®°æ ‡é¢˜</label>
            <input type="text" 
                   id="title" 
                   name="title" 
                   class="mobile-form-input" 
                   placeholder="ä»Šå¤©å‘ç”Ÿäº†ä»€ä¹ˆç‰¹åˆ«çš„äº‹æƒ…ï¼Ÿ"
                   required
                   maxlength="200">
        </div>
        
        <div class="mobile-form-group">
            <label for="content" class="mobile-form-label">ğŸ“„ æ—¥è®°å†…å®¹</label>
            <textarea id="content" 
                      name="content" 
                      class="mobile-form-textarea" 
                      placeholder="è®°å½•ä¸‹ä»Šå¤©çš„æ„Ÿå—ã€æƒ³æ³•æˆ–è€…æœ‰æ„æ€çš„äº‹æƒ…..."
                      required></textarea>
        </div>
        
        <div class="mobile-form-group">
            <label class="mobile-form-label">ğŸ˜Š ä»Šå¤©çš„å¿ƒæƒ…</label>
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-top: 0.5rem;">
                <label class="willingness-option" for="m1">
                    <input type="radio" id="m1" name="mood" value="ğŸ˜„" style="display: none;" checked>
                    <div class="willingness-button active">ğŸ˜„</div>
                    <div class="willingness-label">å¼€å¿ƒ</div>
                </label>
                <label class="willingness-option" for="m2">
                    <input type="radio" id="m2" name="mood" value="ğŸ˜¢" style="display: none;">
                    <div class="willingness-button">ğŸ˜¢</div>
                    <div class="willingness-label">æ‚²ä¼¤</div>
                </label>
                <label class="willingness-option" for="m3">
                    <input type="radio" id="m3" name="mood" value="ğŸ˜ " style="display: none;">
                    <div class="willingness-button">ğŸ˜ </div>
                    <div class="willingness-label">æ„¤æ€’</div>
                </label>
                <label class="willingness-option" for="m4">
                    <input type="radio" id="m4" name="mood" value="ğŸ˜²" style="display: none;">
                    <div class="willingness-button">ğŸ˜²</div>
                    <div class="willingness-label">æƒŠè®¶</div>
                </label>
                <label class="willingness-option" for="m5">
                    <input type="radio" id="m5" name="mood" value="ğŸ˜´" style="display: none;">
                    <div class="willingness-button">ğŸ˜´</div>
                    <div class="willingness-label">å›°å€¦</div>
                </label>
                <label class="willingness-option" for="m6">
                    <input type="radio" id="m6" name="mood" value="ğŸ˜" style="display: none;">
                    <div class="willingness-button">ğŸ˜</div>
                    <div class="willingness-label">å…´å¥‹</div>
                </label>
                <label class="willingness-option" for="m7">
                    <input type="radio" id="m7" name="mood" value="ğŸ¤”" style="display: none;">
                    <div class="willingness-button">ğŸ¤”</div>
                    <div class="willingness-label">æ€è€ƒ</div>
                </label>
                <label class="willingness-option" for="m8">
                    <input type="radio" id="m8" name="mood" value="ğŸ˜" style="display: none;">
                    <div class="willingness-button">ğŸ˜</div>
                    <div class="willingness-label">é…·</div>
                </label>
            </div>
        </div>
        
        <div class="mobile-form-group">
            <label class="mobile-form-label">ğŸ–¼ï¸ æ·»åŠ å›¾ç‰‡ (å¯é€‰)</label>
            <input type="file" 
                   id="image" 
                   name="image" 
                   class="mobile-form-input"
                   accept="image/*">
            <div id="imagePreview" style="margin-top: 1rem;"></div>
        </div>
        
        <button type="submit" class="mobile-submit-btn" id="submitBtn">
            <span id="submitText">âœ… ä¿å­˜æ—¥è®°</span>
            <span id="submitSpinner" style="display: none;">ğŸ”„ ä¿å­˜ä¸­...</span>
        </button>
    </form>
</div>
{% endblock %}

{% block extra_css %}
<style>
.willingness-option {
    display: flex;
    flex-direction: column;
    align-items: center;
    cursor: pointer;
}

.willingness-button {
    width: 50px;
    height: 50px;
    border-radius: 12px;
    border: 2px solid var(--mobile-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    background: var(--mobile-card);
    transition: all 0.2s ease;
    margin-bottom: 0.25rem;
}

.willingness-button:active {
    transform: scale(0.95);
}

.willingness-button.active {
    border-color: var(--mobile-primary);
    background: rgba(102, 126, 234, 0.1);
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.willingness-label {
    font-size: 0.75rem;
    color: var(--mobile-text-light);
    text-align: center;
    line-height: 1.2;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// å¿ƒæƒ…é€‰æ‹©
document.querySelectorAll('input[name="mood"]').forEach(radio => {
    radio.addEventListener('change', function() {
        // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
        document.querySelectorAll('.willingness-button').forEach(btn => {
            btn.classList.remove('active');
        });
        
        // æ·»åŠ activeåˆ°é€‰ä¸­é¡¹
        this.nextElementSibling.classList.add('active');
    });
});

// å›¾ç‰‡é¢„è§ˆ
document.getElementById('image').addEventListener('change', function(e) {
    const preview = document.getElementById('imagePreview');
    preview.innerHTML = '';
    
    if (this.files && this.files[0]) {
        const file = this.files[0];
        if (!file.type.match('image.*')) {
            alert('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶');
            this.value = '';
            return;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.maxWidth = '100%';
            img.style.borderRadius = '8px';
            img.style.boxShadow = 'var(--mobile-shadow)';
            preview.appendChild(img);
        };
        reader.readAsDataURL(file);
    }
});

// è¡¨å•æäº¤å¤„ç†
document.getElementById('diaryForm').addEventListener('submit', function(e) {
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitSpinner = document.getElementById('submitSpinner');
    
    // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
    submitText.style.display = 'none';
    submitSpinner.style.display = 'inline';
    submitBtn.disabled = true;
    
    // éªŒè¯è¡¨å•
    const title = document.getElementById('title').value.trim();
    const content = document.getElementById('content').value.trim();
    
    if (!title || !content) {
        e.preventDefault();
        showToast('âŒ è¯·å¡«å†™æ ‡é¢˜å’Œå†…å®¹');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitText.style.display = 'inline';
        submitSpinner.style.display = 'none';
        submitBtn.disabled = false;
        return;
    }
    
    if (title.length < 2) {
        e.preventDefault();
        showToast('âŒ æ ‡é¢˜è‡³å°‘éœ€è¦2ä¸ªå­—ç¬¦');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitText.style.display = 'inline';
        submitSpinner.style.display = 'none';
        submitBtn.disabled = false;
        return;
    }
    
    if (content.length < 10) {
        e.preventDefault();
        showToast('âŒ å†…å®¹è‡³å°‘éœ€è¦10ä¸ªå­—ç¬¦');
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        submitText.style.display = 'inline';
        submitSpinner.style.display = 'none';
        submitBtn.disabled = false;
        return;
    }
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    showToast('âœ… æ­£åœ¨ä¿å­˜æ—¥è®°...');
});

// Toastæ¶ˆæ¯æ˜¾ç¤º
function showToast(message) {
    const existingToast = document.getElementById('mobileToast');
    if (existingToast) {
        existingToast.remove();
    }
    
    const toast = document.createElement('div');
    toast.id = 'mobileToast';
    toast.textContent = message;
    toast.style.cssText = `
        position: fixed;
        top: calc(env(safe-area-inset-top, 20px) + 80px);
        left: 50%;
        transform: translateX(-50%);
        background: var(--mobile-text);
        color: var(--mobile-card);
        padding: 0.75rem 1.5rem;
        border-radius: 25px;
        font-size: 0.875rem;
        font-weight: 500;
        z-index: 10000;
        box-shadow: var(--mobile-shadow);
        animation: slideUp 0.3s ease-out;
        max-width: calc(100vw - 2rem);
        text-align: center;
    `;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(-50%) translateY(-20px)';
        setTimeout(() => {
            toast.remove();
        }, 300);
    }, 3000);
}
</script>
{% endblock %}