<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vanity">
    <meta name="theme-color" content="#4361ee">
    
    <!-- PWA æ”¯æŒ -->
    <link rel="manifest" href="{% url 'manifest' %}">
    <link rel="apple-touch-icon" href="{% load static %}{% static 'icons/apple-touch-icon.png' %}">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>{% block title %}Vanity - æ™ºèƒ½ä»»åŠ¡ç®¡ç†{% endblock %}</title>
    
    <!-- é¢„åŠ è½½å…³é”®èµ„æº -->
    <link rel="preload" href="{% load static %}{% static 'css/mobile.css' %}" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    
    <!-- æ ·å¼è¡¨ -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
    
    <!-- åŒæ­¥æ›´æ–°çš„ä¸»é¢˜è‰²å½© -->
    <style>
        :root {
            /* æ›´æ–°é¢œè‰²å˜é‡ä»¥åŒ¹é…homeé¡µé¢ */
            --mobile-primary: #4361ee;
            --mobile-secondary: #4cc9f0;
            --mobile-bg: #0a0a16;
            --mobile-card: #1e1e36;
            --mobile-text: #ffffff;
            --mobile-text-light: #b0b0c0;
            --mobile-border: #2d2d4d;
            --mobile-success: #4ade80;
            --mobile-warning: #facc15;
            --mobile-danger: #f87171;
            --mobile-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            --mobile-gradient: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
        }
        
        [data-theme="light"] {
            --mobile-bg: #f0f4f8;
            --mobile-card: #ffffff;
            --mobile-text: #1e293b;
            --mobile-text-light: #64748b;
            --mobile-border: #cbd5e1;
            --mobile-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* æ›´æ–°ç§»åŠ¨ç«¯å¤´éƒ¨æ ·å¼ */
        .mobile-header {
            background: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
            box-shadow: var(--mobile-shadow);
        }
        
        .mobile-logo {
            font-weight: 800;
            font-size: 1.25rem;
        }
        
        /* Emoji å­—ä½“æ”¯æŒ */
        @supports (-webkit-touch-callout: none) {
            .mobile-task-willingness,
            .mobile-task-priority,
            .mobile-nav-icon {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="mobile-container">
        <!-- çŠ¶æ€æ å ä½ -->
        <div class="mobile-status-bar"></div>
        
        <!-- å¤´éƒ¨å¯¼èˆª -->
        <header class="mobile-header">
            <div class="mobile-header-content">
                <div class="mobile-logo">Vanity</div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <span id="menuIcon">â˜°</span>
                </button>
            </div>
        </header>
        
        <!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
        <main class="mobile-main">
            {% block content %}{% endblock %}
        </main>
        
        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <nav class="mobile-bottom-nav">
            <a href="{% url 'content_generator:task_list' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'task_list' %}active{% endif %}">
                <div class="mobile-nav-icon">ğŸ“‹</div>
                <span>ä»»åŠ¡</span>
            </a>
            <a href="{% url 'content_generator:event_list' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'event_list' %}active{% endif %}">
                <div class="mobile-nav-icon">ğŸ“–</div>
                <span>æ—¥è®°</span>
            </a>
            <a href="{% url 'content_generator:add_task' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'add_task' %}active{% endif %}">
                <div class="mobile-nav-icon">â•</div>
                <span>æ·»åŠ </span>
            </a>
            <a href="{% url 'content_generator:daily_summary' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'daily_summary' %}active{% endif %}">
                <div class="mobile-nav-icon">ğŸ“Š</div>
                <span>ç»Ÿè®¡</span>
            </a>
        </nav>
        
        <!-- PWA å®‰è£…æç¤º -->
        <div class="mobile-install-prompt" id="installPrompt">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">å®‰è£… Vanity åº”ç”¨</div>
                    <div style="font-size: 0.875rem; color: var(--mobile-text-light);">æ·»åŠ åˆ°ä¸»å±å¹•ï¼Œè·å¾—æ›´å¥½çš„ä½“éªŒ</div>
                </div>
                <div>
                    <button onclick="dismissInstallPrompt()" style="background: none; border: none; color: var(--mobile-text-light); margin-right: 0.5rem;">å–æ¶ˆ</button>
                    <button onclick="installPWA()" style="background: var(--mobile-primary); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem;">å®‰è£…</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ ¸å¿ƒJavaScript -->
    <script>
        // PWA å®‰è£…é€»è¾‘
        let deferredPrompt;
        let installPromptDismissed = localStorage.getItem('installPromptDismissed');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!installPromptDismissed) {
                setTimeout(() => {
                    document.getElementById('installPrompt').classList.add('show');
                }, 3000);
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA å®‰è£…æˆåŠŸ');
                    }
                    deferredPrompt = null;
                    dismissInstallPrompt();
                });
            }
        }
        
        function dismissInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        }
        
        // ç§»åŠ¨ç«¯èœå•åˆ‡æ¢
        function toggleMobileMenu() {
            const menuIcon = document.getElementById('menuIcon');
            if (menuIcon.textContent === 'â˜°') {
                menuIcon.textContent = 'âœ•';
                // æ˜¾ç¤ºèœå•
                showMobileMenu();
            } else {
                menuIcon.textContent = 'â˜°';
                // éšè—èœå•
                hideMobileMenu();
            }
        }
        
        function showMobileMenu() {
            // åˆ›å»ºå…¨å±èœå•è¦†ç›–å±‚
            const overlay = document.createElement('div');
            overlay.id = 'mobileMenuOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const menu = document.createElement('div');
            menu.style.cssText = `
                background: var(--mobile-card);
                border-radius: 16px;
                padding: 2rem;
                margin: 1rem;
                max-width: 300px;
                width: 100%;
                animation: bounceIn 0.5s ease-out;
            `;
            
            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">èœå•</div>
                    <div style="color: var(--mobile-text-light); font-size: 0.875rem;">é€‰æ‹©ä¸€ä¸ªé€‰é¡¹</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <a href="/content/tasks/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">ğŸ“‹</span>
                        <span>ä»»åŠ¡ç®¡ç†</span>
                    </a>
                    <a href="/content/events/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">ğŸ“–</span>
                        <span>æ—¥è®°ç®¡ç†</span>
                    </a>
                    <a href="/content/daily-summary/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">ğŸ“Š</span>
                        <span>æ¯æ—¥æ€»ç»“</span>
                    </a>
                    <a href="/admin/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">âš™ï¸</span>
                        <span>ç®¡ç†åå°</span>
                    </a>
                </div>
            `;
            
            overlay.appendChild(menu);
            document.body.appendChild(overlay);
            
            // ç‚¹å‡»è¦†ç›–å±‚å…³é—­èœå•
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideMobileMenu();
                }
            });
        }
        
        function hideMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            if (overlay) {
                overlay.remove();
            }
            document.getElementById('menuIcon').textContent = 'â˜°';
        }
        
        // è§¦æ‘¸åé¦ˆ
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('mobile-action-btn') || 
                e.target.classList.contains('mobile-quick-btn') ||
                e.target.classList.contains('mobile-nav-item')) {
                e.target.style.transform = 'scale(0.95)';
            }
        }, {passive: true});
        
        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('mobile-action-btn') || 
                e.target.classList.contains('mobile-quick-btn') ||
                e.target.classList.contains('mobile-nav-item')) {
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 150);
            }
        }, {passive: true});
        
        // é¡µé¢åŠ è½½åŠ¨ç”»
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.mobile-task-card, .mobile-stat-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        });
        
        // é˜²æ­¢iOS Safariçš„æ©¡çš®ç­‹æ•ˆæœ
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.mobile-main') && 
                !e.target.closest('.mobile-task-list')) {
                e.preventDefault();
            }
        }, {passive: false});
        
        // æ³¨å†ŒService Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>