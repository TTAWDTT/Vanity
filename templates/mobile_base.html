<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Vanity">
    <meta name="theme-color" content="#4361ee">
    
    <!-- PWA 支持 -->
    <link rel="manifest" href="{% url 'manifest' %}">
    <link rel="apple-touch-icon" href="{% load static %}{% static 'icons/apple-touch-icon.png' %}">
    <meta name="apple-touch-fullscreen" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>{% block title %}Vanity - 智能任务管理{% endblock %}</title>
    
    <!-- 预加载关键资源 -->
    <link rel="preload" href="{% load static %}{% static 'css/mobile.css' %}" as="style">
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" as="style">
    
    <!-- 样式表 -->
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/mobile.css' %}">
    
    <!-- 同步更新的主题色彩 -->
    <style>
        :root {
            /* 更新颜色变量以匹配home页面 */
            --mobile-primary: #4361ee;
            --mobile-secondary: #4cc9f0;
            --mobile-bg: #0a0a16;
            --mobile-card: #1e1e36;
            --mobile-text: #ffffff;
            --mobile-text-light: #b0b0c0;
            --mobile-border: #2d2d4d;
            --mobile-success: #4ade80;
            --mobile-warning: #facc15;
            --mobile-danger: #f87171;
            --mobile-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            --mobile-gradient: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
        }
        
        [data-theme="light"] {
            --mobile-bg: #f0f4f8;
            --mobile-card: #ffffff;
            --mobile-text: #1e293b;
            --mobile-text-light: #64748b;
            --mobile-border: #cbd5e1;
            --mobile-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        /* 更新移动端头部样式 */
        .mobile-header {
            background: linear-gradient(135deg, var(--mobile-primary), var(--mobile-secondary));
            box-shadow: var(--mobile-shadow);
        }
        
        .mobile-logo {
            font-weight: 800;
            font-size: 1.25rem;
        }
        
        /* Emoji 字体支持 */
        @supports (-webkit-touch-callout: none) {
            .mobile-task-willingness,
            .mobile-task-priority,
            .mobile-nav-icon {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji', sans-serif;
            }
        }
    </style>
    
    {% block extra_css %}{% endblock %}
</head>
<body>
    <div class="mobile-container">
        <!-- 状态栏占位 -->
        <div class="mobile-status-bar"></div>
        
        <!-- 头部导航 -->
        <header class="mobile-header">
            <div class="mobile-header-content">
                <div class="mobile-logo">Vanity</div>
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()">
                    <span id="menuIcon">☰</span>
                </button>
            </div>
        </header>
        
        <!-- 主要内容区域 -->
        <main class="mobile-main">
            {% block content %}{% endblock %}
        </main>
        
        <!-- 底部导航栏 -->
        <nav class="mobile-bottom-nav">
            <a href="{% url 'content_generator:task_list' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'task_list' %}active{% endif %}">
                <div class="mobile-nav-icon">📋</div>
                <span>任务</span>
            </a>
            <a href="{% url 'content_generator:event_list' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'event_list' %}active{% endif %}">
                <div class="mobile-nav-icon">📖</div>
                <span>日记</span>
            </a>
            <a href="{% url 'content_generator:add_task' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'add_task' %}active{% endif %}">
                <div class="mobile-nav-icon">➕</div>
                <span>添加</span>
            </a>
            <a href="{% url 'content_generator:daily_summary' %}" class="mobile-nav-item {% if request.resolver_match.url_name == 'daily_summary' %}active{% endif %}">
                <div class="mobile-nav-icon">📊</div>
                <span>统计</span>
            </a>
        </nav>
        
        <!-- PWA 安装提示 -->
        <div class="mobile-install-prompt" id="installPrompt">
            <div style="display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <div style="font-weight: 600; margin-bottom: 0.25rem;">安装 Vanity 应用</div>
                    <div style="font-size: 0.875rem; color: var(--mobile-text-light);">添加到主屏幕，获得更好的体验</div>
                </div>
                <div>
                    <button onclick="dismissInstallPrompt()" style="background: none; border: none; color: var(--mobile-text-light); margin-right: 0.5rem;">取消</button>
                    <button onclick="installPWA()" style="background: var(--mobile-primary); color: white; border: none; border-radius: 8px; padding: 0.5rem 1rem;">安装</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 核心JavaScript -->
    <script>
        // PWA 安装逻辑
        let deferredPrompt;
        let installPromptDismissed = localStorage.getItem('installPromptDismissed');
        
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            if (!installPromptDismissed) {
                setTimeout(() => {
                    document.getElementById('installPrompt').classList.add('show');
                }, 3000);
            }
        });
        
        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA 安装成功');
                    }
                    deferredPrompt = null;
                    dismissInstallPrompt();
                });
            }
        }
        
        function dismissInstallPrompt() {
            document.getElementById('installPrompt').classList.remove('show');
            localStorage.setItem('installPromptDismissed', 'true');
        }
        
        // 移动端菜单切换
        function toggleMobileMenu() {
            const menuIcon = document.getElementById('menuIcon');
            if (menuIcon.textContent === '☰') {
                menuIcon.textContent = '✕';
                // 显示菜单
                showMobileMenu();
            } else {
                menuIcon.textContent = '☰';
                // 隐藏菜单
                hideMobileMenu();
            }
        }
        
        function showMobileMenu() {
            // 创建全屏菜单覆盖层
            const overlay = document.createElement('div');
            overlay.id = 'mobileMenuOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.8);
                z-index: 9999;
                display: flex;
                align-items: center;
                justify-content: center;
                animation: fadeIn 0.3s ease-out;
            `;
            
            const menu = document.createElement('div');
            menu.style.cssText = `
                background: var(--mobile-card);
                border-radius: 16px;
                padding: 2rem;
                margin: 1rem;
                max-width: 300px;
                width: 100%;
                animation: bounceIn 0.5s ease-out;
            `;
            
            menu.innerHTML = `
                <div style="text-align: center; margin-bottom: 2rem;">
                    <div style="font-size: 1.5rem; font-weight: 700; margin-bottom: 0.5rem;">菜单</div>
                    <div style="color: var(--mobile-text-light); font-size: 0.875rem;">选择一个选项</div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <a href="/content/tasks/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">📋</span>
                        <span>任务管理</span>
                    </a>
                    <a href="/content/events/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">📖</span>
                        <span>日记管理</span>
                    </a>
                    <a href="/content/daily-summary/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">📊</span>
                        <span>每日总结</span>
                    </a>
                    <a href="/admin/" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border-radius: 12px; background: var(--mobile-bg); text-decoration: none; color: var(--mobile-text);">
                        <span style="font-size: 1.5rem;">⚙️</span>
                        <span>管理后台</span>
                    </a>
                </div>
            `;
            
            overlay.appendChild(menu);
            document.body.appendChild(overlay);
            
            // 点击覆盖层关闭菜单
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    hideMobileMenu();
                }
            });
        }
        
        function hideMobileMenu() {
            const overlay = document.getElementById('mobileMenuOverlay');
            if (overlay) {
                overlay.remove();
            }
            document.getElementById('menuIcon').textContent = '☰';
        }
        
        // 触摸反馈
        document.addEventListener('touchstart', function(e) {
            if (e.target.classList.contains('mobile-action-btn') || 
                e.target.classList.contains('mobile-quick-btn') ||
                e.target.classList.contains('mobile-nav-item')) {
                e.target.style.transform = 'scale(0.95)';
            }
        }, {passive: true});
        
        document.addEventListener('touchend', function(e) {
            if (e.target.classList.contains('mobile-action-btn') || 
                e.target.classList.contains('mobile-quick-btn') ||
                e.target.classList.contains('mobile-nav-item')) {
                setTimeout(() => {
                    e.target.style.transform = '';
                }, 150);
            }
        }, {passive: true});
        
        // 页面加载动画
        document.addEventListener('DOMContentLoaded', function() {
            const cards = document.querySelectorAll('.mobile-task-card, .mobile-stat-card');
            cards.forEach((card, index) => {
                setTimeout(() => {
                    card.classList.add('fade-in');
                }, index * 100);
            });
        });
        
        // 防止iOS Safari的橡皮筋效果
        document.addEventListener('touchmove', function(e) {
            if (e.target.closest('.mobile-main') && 
                !e.target.closest('.mobile-task-list')) {
                e.preventDefault();
            }
        }, {passive: false});
        
        // 注册Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then((registration) => {
                        console.log('SW registered: ', registration);
                    })
                    .catch((registrationError) => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
    
    {% block extra_js %}{% endblock %}
</body>
</html>